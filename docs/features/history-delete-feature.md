# 历史记录删除功能说明

## 📋 功能概述

为TradingAgents项目的历史记录系统添加了完整的删除功能，用户可以方便地管理和清理不需要的分析记录。

## 🆕 新增功能

### 1. 单条记录删除
- **位置**: 历史记录页面 → 记录查看标签
- **功能**: 可以选择一个或多个记录进行删除
- **特点**: 支持多选，带确认机制

### 2. 批量删除操作
- **按时间删除**: 删除指定天数之前的旧记录
- **按股票删除**: 删除指定股票的所有记录
- **清空所有**: 删除所有历史记录（危险操作）

### 3. 后端删除方法
- `delete_record_by_id(record_id)`: 删除单条记录
- `delete_records_by_ids(record_ids)`: 批量删除记录
- `delete_old_records(days)`: 删除旧记录

## 🖥️ 使用方法

### 在Web界面中删除记录

1. **访问历史记录页面**
   ```
   打开Web应用 → 导航到"分析历史记录"页面
   ```

2. **选择记录删除（推荐）**
   ```
   记录查看标签 → 选择要删除的记录 → 点击"删除选中记录"
   ```

3. **管理工具删除**
   ```
   管理工具标签 → 选择删除方式：
   - 批量清理：按时间删除旧记录
   - 快速删除：按股票代码删除
   - 危险操作：清空所有记录
   ```

### 删除功能特点

#### ✅ 安全机制
- **二次确认**: 所有删除操作都需要确认
- **状态提示**: 清楚显示成功/失败状态
- **操作日志**: 记录删除操作的详细信息

#### 🔄 跨存储支持
- **MongoDB**: 支持MongoDB数据库删除
- **文件存储**: 支持文件系统删除（重写文件）
- **Redis缓存**: 自动清理相关缓存

#### 📊 批量操作
- **多选删除**: 可以同时选择多条记录删除
- **按条件删除**: 支持按股票代码、时间等条件批量删除
- **进度反馈**: 显示删除进度和结果

## 🛠️ 技术实现

### 数据库删除
```python
# MongoDB删除
result = collection.delete_one({"record_id": record_id})

# 批量删除
result = collection.delete_many({"record_id": {"$in": record_ids}})
```

### 文件存储删除
```python
# 文件删除通过重写文件实现
# 1. 读取原文件，过滤要删除的记录
# 2. 重写文件，只保留需要保留的记录
# 3. 如果文件为空，直接删除文件
```

### 缓存清理
```python
# Redis缓存清理
redis_client.delete(f"analysis_history:{record_id}")
```

## 🔍 使用示例

### 编程方式删除
```python
from tradingagents.utils.analysis_history import get_history_manager

# 获取历史记录管理器
history_manager = get_history_manager()

# 删除单条记录
success = history_manager.delete_record_by_id("record_id_here")

# 批量删除
deleted_count = history_manager.delete_records_by_ids(["id1", "id2", "id3"])

# 删除旧记录（30天前）
deleted_count = history_manager.delete_old_records(days=30)
```

### Web界面操作流程
```
1. 打开历史记录页面
2. 在"记录查看"标签中，找到"记录管理"部分
3. 选择要删除的记录（可多选）
4. 点击"删除选中记录"按钮
5. 确认删除操作
6. 查看删除结果
```

## ⚠️ 注意事项

### 数据安全
- **不可恢复**: 删除操作是永久性的，无法恢复
- **备份建议**: 删除前建议先导出数据备份
- **权限控制**: 仅限管理员用户操作重要删除功能

### 性能考虑
- **大量数据**: 删除大量记录可能需要一些时间
- **存储类型**: 文件存储的删除比数据库删除稍慢
- **缓存一致性**: 删除操作会自动清理相关缓存

### 错误处理
- **部分失败**: 批量删除中部分记录可能失败，会返回实际删除数量
- **网络问题**: 数据库连接问题时会自动降级到文件操作
- **日志记录**: 所有删除操作都会记录到日志中

## 🧪 测试

运行测试脚本验证删除功能：
```bash
python test_delete_functionality.py
```

测试内容包括：
- 创建测试记录
- 单条记录删除
- 批量记录删除
- 删除结果验证

## 📝 更新日志

- **2025-01-30**: 新增历史记录删除功能
  - 添加单条和批量删除方法
  - 实现Web界面删除操作
  - 支持多种存储后端
  - 添加安全确认机制

## 🔗 相关文件

- **后端实现**: `tradingagents/utils/analysis_history.py`
- **Web界面**: `web/modules/analysis_history.py`
- **测试文件**: `test_delete_functionality.py`
